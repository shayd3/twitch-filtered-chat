<!DOCTYPE xhtml>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Filtered Chat</title>
  <meta charset="utf-8" />
  <link href="assets/settings_white.png" rel="shortcut icon" type="image/png" />
  <link href="main.css" rel="stylesheet" type="text/css" />
  <script type="text/javascript" src="assets/jquery-3.4.0.js"></script>
  <script type="text/javascript" src="config.js"></script>
  <script type="text/javascript" src="colors.js"></script>
  <!--<script type="text/javascript" src="htmlgen.js"></script>
  <script type="text/javascript" src="plugins/plugins.js"></script>
  <script type="text/javascript" src="filtered-chat.js"></script>-->
  <script type="text/javascript" src="main.js"></script>
  <script type="text/javascript">
"use strict";

function asset_error(asset, e) {
  let m = e.toString();
  m = m + "\n";
  m = JSON.stringify(asset);
  m + m + "\n";
  m = JSON.stringify(e);
  m = m + "\n";
  if (e.stack) m = m + e.stack;
  alert("asset error: " + m);
}

AddAsset("htmlgen.js", null, asset_error);
AddAsset("plugins/plugins.js", null, asset_error);
AddAsset("filtered-chat.js", null, asset_error);

/** QUERY STRING USAGE
 *
 * The following are parsed here in index.html:
 *  layout      - Layout to use
 *
 * The following are parsed in filtered-chat.js:
 *  config_key  - Config key override (default: "config")
 *  clientid    - ClientID to use for Twitch asset loading
 *  user        - Username to use (requires pass)
 *  pass        - OAuth token to use (requires user; removed once parsed)
 *  debug       - A number or "debug" or "trace" (default: 0)
 *  channels    - Channels to join (without #), separated by commas
 *  noassets    - Prevents loading of image (badge, emote, cheer) assets
 *  noffz       - Disable FFZ support entirely
 *  nobttv      - Disable BTTV support entirely
 *  hmax        - Maximum number of chat messages to retain (default 300)
 *  trans       - Makes the backgrounds completely transparent
 *  module1     - The encoded module configuration for the first module
 *  module2     - The encoded module configuration for the second module
 *  reconnect   - Automatically reconnect if disconnected (default false)
 *  plugins     - Load plugins (default false)
 *
 * layout=single uses module1
 * layout=double uses [module1, module2]
 *
 * Authenticated:
      ?clientid=<YOUR-CLIENTID>
      &channels=dwangoAC,pangaeapanga
      &user=<YOUR-TWITCH-USERNAME>
      &pass=oauth:<YOUR-OAUTH>
      &layout=single:chat
 * Unauthenticated:
      ?channels=dwangoAC,pangaeapanga
      &layout=double:nochat
 * Unauthenticated; filter out TAS9000 and messages starting with "!":
      ?channels=dwangoAC
      &module1=Chat,111111,,,TAS9000,!,
      &layout=single:nochat
 */

function Main(global) {
  /* Greetings! Can't use Util as that isn't loaded yet */
  console.log("Hello!");

  /* Populate the debug div with text */
  function debug_msg(msg) {
    let d = document.getElementById("debug");
    if (d) {
      d.innerHTML = `${msg}<br />${d.innerHTML}`;
    }
  }
  global.debug_msg = debug_msg;

  AddAsset("utility.js", "twitch-api");
  AddAsset("twitch-utility.js", "twitch-api");
  AddAsset("colors.js", "twitch-api");
  AddAsset("client.js", "twitch-api");

  /* Populate templates and load the client */
  function index_main() {
    Util.LogOnly("Assets loaded; initializing page...");

    /* Parse layout */
    let layout_raw = Util.ParseQueryString().layout;
    if (layout_raw === undefined) layout_raw = "double:chat";
    let layout = ParseLayout(layout_raw);

    /* Remove the top-level "Loading" message */
    $("#wrapper #wrapper-loading").remove();
    /* Create the chat input elements */
    let $ChatBox = $(`<textarea id="txtChat"></textarea>`);
    $ChatBox.attr("placeholder", "Send a message");
    $ChatBox.attr("hist-index", "-1");
    $ChatBox.attr("tab-index", "-1");
    $ChatBox.attr("tab-word", "");
    let $Chat = $(`<div id="chat"></div>`).append($ChatBox);

    let $Column1 = $("#column1");
    let $Column2 = $("#column2");
    let $Columns = $(".column");
    let $Module1 = $("#module1");
    let $Module2 = $("#module2");
    let $Modules = $(".module");
    $Modules.find('.clear-chat-icon')
            .attr("width", "1.1em")
            .attr("height", "1.1em");
    $Modules.find('.header .settings input[type="checkbox"]')
            .attr('checked', 'checked');
    $Modules.find('.header label.name').val('Chat');
    $Modules.find('.header input.name').attr("value", 'Chat');

    if (layout.Cols == "single") {
      $Column1.removeClass("left");
      $Column1.addClass("full");
      $Module1.removeClass("left");
      $Module1.addClass('full');
      $Column1.show();
      $Column2.remove();
    } else {
      $Columns.show();
    }

    let $ChatModule = null;
    if (layout.Chat) {
      $ChatModule = layout.Cols == "single" ? $Module1 : $Module2;
    }
    if ($ChatModule !== null) {
      $ChatModule.removeClass("no-chat");
      $ChatModule.addClass("has-chat");
      $ChatModule.find(".content").append($Chat);
    }

    if (layout.Tesla) {
      $(".content").css("overflow-y", "scroll");
    }

    /* If slim layout, remove the entire header */
    if (layout.Slim) {
      $(".header").hide();
      $(".content").addClass("slim");
      $("#settings_button").hide();
    }

    Util.LogOnly("Waiting for document to finish rendering...");

    /* Once rerendering is complete, start up the client */
    $(document).ready(function() {
      try {
        Util.LogOnly("Document rendered; setting up TFC...");
        client_main(layout);
        document.dispatchEvent(new Event("tfc-loaded"));
      } catch(e) {
        alert("client_main error: " + e.toString());
        alert("Stacktrace: " + e.stack ? e.stack.toString() : "no stack");
        throw e;
      }
    });
  }

  /* Once the document is loaded, wait for the scripts, then do layout */
  onReady(index_main);
}
  </script>
</head>
<body onload="Main(window)">
  <!-- Debugging -->
  <span class="debug" id="debug" style="display: none">Debug active</span>
  <!-- Content wrapper -->
  <div id="wrapper">
    <div id="wrapper-loading" class="loading">Loading Panels...</div>
    <div class="column left" id="column1" style="display: none">
      <div class="module left no-chat" id="module1">
        <div class="header">
          <div class="menu">
            <div></div>
            <div></div>
            <div></div>
          </div>
          <span class="clear-chat">
            <a class="clear-chat-link" href="javascript:void(0)" title="Clear" alt="Clear">
              <img class="clear-chat-icon" src="assets/no-entry.svg" />
            </a>
          </span>
          <div class="settings">
            <p>Include:</p>
            <ul class="include">
              <li><label><input type="checkbox" class="pleb" />Non-subs</label></li>
              <li><label><input type="checkbox" class="sub" />Subscribers</label></li>
              <li><label><input type="checkbox" class="vip" />VIPs</label></li>
              <li><label><input type="checkbox" class="mod" />Moderators</label></li>
              <li><label><input type="checkbox" class="event" />Channel events</label></li>
              <li><label><input type="checkbox" class="bits" />Bit messages</label></li>
              <li class="textbox include_user">
                <label>From user:</label>
                <input type="text" class="user" />
              </li>
              <li class="textbox include_keyword">
                <label>Contains:</label>
                <input type="text" class="keyword" />
              </li>
            </ul>
            <p>Limit to:</p>
            <ul>
              <li class="textbox from_channel">
                <label>Channel:</label>
                <input type="text" class="channel" />
              </li>
            </ul>
            <p>Exclude:</p>
            <ul class="exclude">
              <li class="textbox exclude_user">
                <label>From user:</label>
                <input type="text" class="user" />
              </li>
              <li class="textbox exclude_startswith">
                <label>Starts with:</label>
                <input type="text" class="keyword" />
              </li>
            </ul>
          </div>
          <label class="name"></label>
          <input type="text" class="name"></input>
        </div>
        <div class="content"><div class="loading">Loading...</div></div>
      </div>
    </div>
    <div class="column right" id="column2" style="display: none">
      <div class="module right no-chat" id="module2">
        <div class="header">
          <div class="menu">
            <div></div>
            <div></div>
            <div></div>
          </div>
          <span class="clear-chat">
            <a class="clear-chat-link" href="javascript:void(0)" title="Clear" alt="Clear">
              <img class="clear-chat-icon" src="assets/no-entry.svg" />
            </a>
          </span>
          <div class="settings">
            <p>Include:</p>
            <ul class="include">
              <li><label><input type="checkbox" class="pleb" />Non-subs</label></li>
              <li><label><input type="checkbox" class="sub" />Subscribers</label></li>
              <li><label><input type="checkbox" class="vip" />VIPs</label></li>
              <li><label><input type="checkbox" class="mod" />Moderators</label></li>
              <li><label><input type="checkbox" class="event" />Channel events</label></li>
              <li><label><input type="checkbox" class="bits" />Bit messages</label></li>
              <li class="textbox include_user">
                <label>From user:</label>
                <input type="text" class="user" />
              </li>
              <li class="textbox include_keyword">
                <label>Contains:</label>
                <input type="text" class="keyword" />
              </li>
            </ul>
            <p>Limit to:</p>
            <ul>
              <li class="textbox from_channel">
                <label>Channel:</label>
                <input type="text" class="channel" />
              </li>
            </ul>
            <p>Exclude:</p>
            <ul class="exclude">
              <li class="textbox exclude_user">
                <label>From user:</label>
                <input type="text" class="user" />
              </li>
              <li class="textbox exclude_startswith">
                <label>Starts with:</label>
                <input type="text" class="keyword" />
              </li>
            </ul>
          </div>
          <label class="name"></label>
          <input type="text" class="name"></input>
        </div>
        <div class="content"><div class="loading">Loading...</div></div>
      </div>
    </div>
  </div>
  <!-- Settings -->
  <div id="settings">
    <header>Settings</header>
    <ul>
      <li>
        <label>Channels:</label>
        <input type="text" id="txtChannel" />
      </li>
      <li>
        <label>Nick:</label>
        <input type="text" id="txtNick" />
      </li>
      <li>
        <label>ClientID:</label>
        <input type="text" id="txtClientID" />
      </li>
      <li>
        <label>OAuth:</label>
        <input type="password" id="txtPass" />
        <input type="text" id="txtPassDummy"
               value="Cached"
               style="display: none"
               disabled />
      </li>
      <li>
        <label>Transparent:</label>
        <input type="checkbox" id="cbTransparent" class="middle" />
      </li>
      <li>
        <label>BG CSS:</label>
        <input type="text" id="txtBGImage" />
      </li>
      <li>
        <label>Debugging:</label>
        <select id="selDebug">
          <option value="0" selected>Disabled</option>
          <option value="1">Debug</option>
          <option value="2">Trace</option>
        </select>
      </li>
      <li>
        <label>No Force:</label>
        <input type="checkbox" id="cbForce" class="middle" />
      </li>
    </ul>
    <footer>
      <span class="fl"><a onclick="$('#settings_button').click();">Close</a></span>
      <span class="fr" id="reconnect"><a>Reconnect</a></span>
    </footer>
  </div>
  <img id="settings_button" src="assets/settings_white.png" alt="Settings" />
  <!-- Username context window -->
  <div id="username_context" class="username_context"></div>
  <!-- Populate the page with a one-time script to focus on the chat -->
  <script type="text/javascript" id="txtChatFocus">
  function focus_once() {
    let $tc = $("#txtChat");
    if ($tc && $tc.length > 0 && !$tc.attr("focused")) {
      $tc.attr("focused", "1");
      $tc[0].focus();
    }
  }
  document.addEventListener("tfc-loaded", focus_once);
  </script>
</body>
</html>
